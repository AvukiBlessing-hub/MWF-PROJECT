doctype html
html(lang="en")
  head
    meta(charset="UTF-8")
    meta(name="viewport", content="width=device-width, initial-scale=1")
    title Sales Table
    link(rel="stylesheet", href="/css/salestable.css")

  body
    nav.navbar
      ul
        li: a(href="/dashboard") Dashboard 
        li: a(href="/signup") Register users
        li: a(href="/userlist") Registered users 
        li: a(href="/stock") Stock
        li: a(href="/stocklist") Stocklist
        li: a(href="/sales") Sales 
        li: a(href="/saleslist") Saleslist
        li: a(href="/delivery") Delivery
        li: a(href="/deliverylist") Deliverylist
        li: a(href="/logout") Log out

    .container
      h1 Sales Table
      .action-buttons
        a.btn.btn-black(href="/sales") Add More Sales
        button#generateAllReport.btn.btn-report(type="button", onclick="generateFullSalesReport()") Generate Full Report

      table#salesTable
        thead
          tr
            th Customer
            th Product Type
            th Product
            th Qty
            th Quality
            th Cost (shs)
            th Transport
            th Agent
            th Total (shs)
            if currentUser && ['Manager','Attendant'].includes(currentUser.role)
              th Actions

        tbody
          - var totalQuantity = 0
          - var totalCostPrice = 0
          - var totalTotalPrice = 0
          - var safeItems = Array.isArray(items) ? items : []

          if safeItems.length
            each item in safeItems
              - var qty = item.quantity || 0
              - var cost = item.costPrice || 0
              - var total = item.totalPrice || 0
              - totalQuantity += qty
              - totalCostPrice += cost
              - totalTotalPrice += total
              tr
                td #{item.customerName || 'N/A'}
                td #{item.productType || 'N/A'}
                td #{item.productName || 'N/A'}
                td #{qty}
                td #{item.quality || 'N/A'}
                td #{cost.toFixed(2)}
                td #{item.transportFee ? 'Yes' : 'No'}
                td #{item.Attendant ? (item.Attendant.fullname || item.Attendant.name || 'N/A') : 'N/A'}
                td #{total.toFixed(2)}

                if currentUser && currentUser.role === 'Manager'
                  td.action-cell
                    a.btn.btn-warning(href=`/editsales/${item._id}`, title="Edit") ‚úèÔ∏è
                    form(method='POST', action=`/deletesales/${item._id}`, style="display:inline;", onsubmit="return confirmDelete(event)")
                      button.btn.btn-danger(type='submit', title="Delete") üóëÔ∏è
                    button.btn.btn-info(type='button', onclick=`generateSaleReport(event, '${item._id}', '${item.customerName || ''}')`, title="Generate Report") üìÑ

                else if currentUser && currentUser.role === 'Attendant'
                  td.action-cell
                    // ‚úÖ FIXED: changed href from /salesreceipt/ to /receipt/
                    a.btn.btn-receipt(href=`/receipt/${item._id}`, title="Receipt") üßæ
                    button.btn.btn-info(type='button', onclick=`generateSaleReport(event, '${item._id}', '${item.customerName || ''}')`, title="Generate Report") üìÑ

          else
            tr#noSalesRow
              td(colspan="10", style="text-align:center; color:gray; padding:30px;") No sales available

        tfoot
          tr(style="background-color:#000; color:#fff; font-weight:bold;")
            td(colspan="3", style="text-align:right; padding-right:15px;") TOTALS:
            td#totalQuantity #{totalQuantity}
            td
            td#totalCostPrice #{totalCostPrice.toFixed(2)}
            td
            td
            td#totalTotalPrice #{totalTotalPrice.toFixed(2)}
            if currentUser && ['Manager','Attendant'].includes(currentUser.role)
              td

    script(src="/js/salestable.js")
